<?php
	
	include "includes/servidor.php";
	
	$sqlAluno = "SELECT * FROM alunos WHERE id='". $_SESSION['UsuarioAlunosID'] ."'";
	$resultadoAluno = mysqli_query($conexao, $sqlAluno);
	$nlAluno = mysqli_num_rows($resultadoAluno);
	
	if($nlAluno > 0){
		$Aluno = mysqli_fetch_array($resultadoAluno);
	}else{
		echo "<script type='text/javascript' charset='utf-8'> alert('O seu cadastro n\u00e3o foi localizado!'); window.location.href='includes/logout.php'; </script>";
	}
	
	$filtroCidades = array();
	$filtroAreasAtuacao = array();
	$fCid = "";
	$fAreAtu = "";
	
	if(isset($_POST['cidades'])){
		if(count($_POST['cidades']) > 0){
			foreach($_POST['cidades'] as $item){
				array_push($filtroCidades, $item);
				if($fCid == ""){
					$fCid .= $item;
				}else{
					$fCid .= ", " . $item;
				}
			}
		}
	}
	if(isset($_POST['areas_atuacao'])){
		if(count($_POST['areas_atuacao']) > 0){
			foreach($_POST['areas_atuacao'] as $item){
				array_push($filtroAreasAtuacao, $item);
				if($fAreAtu == ""){
					$fAreAtu .= $item;
				}else{
					$fAreAtu .= ", " . $item;
				}
			}
		}
	}

?>
<!-- VAGAS ALUNOS -->
<div class="container">
	<br><br>
	<!-- FORMULÁRIO DE BUSCA DE VAGAS -->
<?php include "html/menu/menuVagasAlunos.html" ?>	

	<hr>
	<!-- FIM DO FORMULÁRIO DE BUSCA DE VAGAS -->
	<div class="row">
		<!-- FILTROS DAS VAGAS -->
		<div class="col-md-2">
			<form method="post">
			<h4 class="text-danger">Filtros</h4>
			<h5>Cidades</h5>
<?php
	
	$sqlCidades = "SELECT * FROM cidades";
	$resultadoCidades = mysqli_query($conexao, $sqlCidades);
	$nlCidades = mysqli_num_rows($resultadoCidades);
	
	if($nlCidades > 0){
		while($Cidades = mysqli_fetch_array($resultadoCidades)){
			
			if(in_array($Cidades['id'], $filtroCidades)){
				$checkedCidades = "checked";
			}else{
				$checkedCidades = "";
			}
?>			
			<input type="checkbox" name="cidades[]" id="<?php echo $Cidades['nome'] ?>_<?php echo $Cidades['id'] ?>" value="<?php echo $Cidades['id'] ?>" <?php echo $checkedCidades ?>>
			<label for="<?php echo $Cidades['nome'] ?>_<?php echo $Cidades['id'] ?>"><?php echo $Cidades['nome'] ?>/<?php echo $Cidades['estado'] ?></label><br>
<?php
		}
	}else{
?>
			<label>Não há cidades para exibir...</label><br>
<?php
	}
?>			
			<br><br>
			<h5>Áreas de Atuação</h5>
<?php
	
	$sqlAreasAtuacao = "SELECT * FROM areas_atuacao";
	$resultadoAreasAtuacao = mysqli_query($conexao, $sqlAreasAtuacao);
	$nlAreasAtuacao = mysqli_num_rows($resultadoAreasAtuacao);
	
	if($nlAreasAtuacao > 0){
		while($AreasAtuacao = mysqli_fetch_array($resultadoAreasAtuacao)){
			
			if(in_array($AreasAtuacao['id'], $filtroAreasAtuacao)){
				$checkedAreasAtuacao = "checked";
			}else{
				$checkedAreasAtuacao = "";
			}
?>				
			<input type="checkbox" name="areas_atuacao[]" id="<?php echo $AreasAtuacao['nome'] ?>_<?php echo $AreasAtuacao['id'] ?>" value="<?php echo $AreasAtuacao['id'] ?>" <?php echo $checkedAreasAtuacao ?>>
			<label for="<?php echo $AreasAtuacao['nome'] ?>_<?php echo $AreasAtuacao['id'] ?>"><?php echo $AreasAtuacao['nome'] ?></label><br>
<?php
		}
	}else{
?>
			<label>Não há áreas de atuação para exibir...</label><br>
<?php
	}
?>			
			<div class="row">
				<div class="col-md-6 d-grid gap-2">
					<a href="?pagina=vagasEmpresa"><button type="button" class=" btn btn-secondary">LIMPAR FILTROS</button></a>
				</div>
				<div class="col-md-6">
					<button type="submit" class=" btn btn-success">APLICAR FILTROS</button>
				</div>
			</div>
			</form>
		</div>
		
		<!-- FIM DOS FILTROS DAS VAGAS -->
		<!-- VAGAS DISPONÍVEIS -->
		<div class="col-md-10">
<?php

	if(isset($_POST['cidades'])){
		$completaSqlCidades = "AND cidades_id IN (". $fCid .")";
	}else{
		$completaSqlCidades = "";
	}
	
	if(isset($_POST['areas_atuacao'])){
		$completaSqlAreasAtuacao = "AND areas_atuacao_id IN (". $fAreAtu .")";
	}else{
		$completaSqlAreasAtuacao = "";
	}
	
	$sqlVagas = "SELECT * FROM vagas WHERE ativo='1' ". $completaSqlCidades ." ". $completaSqlAreasAtuacao ."";
	$resultadoVagas = mysqli_query($conexao, $sqlVagas);
	$nlVagas = mysqli_num_rows($resultadoVagas);
	
	if($nlVagas > 0){
		while($Vagas = mysqli_fetch_array($resultadoVagas)){
			
			$sqlCidadesVaga = "SELECT * FROM cidades WHERE id='". $Vagas['cidades_id'] ."'";
			$resultadoCidadesVaga = mysqli_query($conexao, $sqlCidadesVaga);
			$CidadesVaga = mysqli_fetch_array($resultadoCidadesVaga);
			
			$sqlAreasAtuacaoVaga = "SELECT * FROM areas_atuacao WHERE id='". $Vagas['areas_atuacao_id'] ."'";
			$resultadoAreasAtuacaoVaga = mysqli_query($conexao, $sqlAreasAtuacaoVaga);
			$AreasAtuacaoVaga = mysqli_fetch_array($resultadoAreasAtuacaoVaga);
			
			$sqlEmpresaVaga = "SELECT * FROM empresas WHERE id='". $Vagas['empresas_id'] ."'";
			$resultadoEmpresaVaga = mysqli_query($conexao, $sqlEmpresaVaga);
			$EmpresaVaga = mysqli_fetch_array($resultadoEmpresaVaga);
			
			if($Vagas['local_trabalho'] == "presencial"){
				$iconeVaga = "<i class='fas fa-building'></i>";
				$selectedPresencial = "selected";
				$selectedRemoto = "";
				$selectedOutro = "";
			}elseif($Vagas['local_trabalho'] == "remoto"){
				$iconeVaga = "<i class='fas fa-laptop-house'></i>";
				$selectedPresencial = "";
				$selectedRemoto = "selected";
				$selectedOutro = "";
			}else{
				$iconeVaga = "<i class='fas fa-network-wired'></i>";
				$selectedPresencial = "";
				$selectedRemoto = "";
				$selectedOutro = "selected";
			}
			
?>		
			<div class="mostra-vaga">
				<div class="row">
					<div class="col-md-2 icone-vaga">
						<?php echo $iconeVaga ?>
					</div>
					<div class="col-md-8">
						<h1><?php echo $Vagas['nome'] ?></h1>
						<small>(<?php echo mb_strtoupper($Vagas['local_trabalho']) ?>) <?php echo $AreasAtuacaoVaga['nome'] ?></small>
						<p><?php echo $EmpresaVaga['nome'] ?></p>
						<p><?php echo $Vagas['descricao'] ?></p>
					</div>
					<div class="col-md-2">
<?php 
			$sqlCandidatura = "SELECT * FROM candidatos_vagas WHERE vagas_id='". $Vagas['id'] ."' AND alunos_id='". $Aluno['id'] ."'";
			$resultadoCandidatura = mysqli_query($conexao, $sqlCandidatura);
			$nlCandidatura = mysqli_num_rows($resultadoCandidatura);
			
			if($nlCandidatura > 0){
				$Candidatura = mysqli_fetch_array($resultadoCandidatura);
				$obsCandidatura = $Candidatura['obs_aluno'];
				$idCandidatura = $Candidatura['id'];
?>
						<button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalCandidaturaEnviada_<?php echo $Vagas['id'] ?>">CANDIDATURA ENVIADA</button>
<?php
			}else{
				$obsCandidatura = "";
				$idCandidatura = "";
?>
						<button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#modalCandidatar_<?php echo $Vagas['id'] ?>">CANDIDATAR AGORA</button>
<?php
			}				
?>					
						
					</div>
				</div>
				<div class="row">
					<div class="col-md-6">
						<p class="local-vaga"><i class="fas fa-map-marker-alt"></i> <?php echo $CidadesVaga['nome'] ?>/<?php echo $CidadesVaga['estado'] ?>.</p>
					</div>
					<div class="col-md-6">
						<p class="data-vaga"><i class="fas fa-clock"></i> <?php echo date("d/m/Y", strtotime($Vagas['data'])) ?>.</p>
					</div>
				</div>
			</div>
			<br>
			<!-- Modal Candidatar -->
			<div class="modal fade" id="modalCandidatar_<?php echo $Vagas['id'] ?>" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h1 class="modal-title fs-5" id="exampleModalLabel">Candidatar a uma vaga</h1>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							
							<b>Você está prestes a candidatar-se na seguinte vaga:</b><br>
							<b>Vaga: </b><?php echo $Vagas['nome'] ?><br>
							<b>Empresa: </b><?php echo $EmpresaVaga['nome'] ?><br>
							<b>Tipo da Vaga: </b><?php echo mb_strtoupper($Vagas['local_trabalho']) ?><br>
							Para continuar, fale um pouco sobre você no campo abaixo, informando seu objetivo profissional e/ou ético.
							<hr>
							<form method="post" action="includes/cadastrarCandidaturaAluno.php">
							<textarea class="form-control" name="obs_aluno" required></textarea>
						</div>
						<div class="modal-footer">
							<input type="hidden" name="data" value="<?php echo date("Y-m-d") ?>">
							<input type="hidden" name="alunos_id" value="<?php echo $Aluno['id'] ?>">
							<input type="hidden" name="vagas_id" value="<?php echo $Vagas['id'] ?>">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
							<button type="submit" class="btn btn-primary">Enviar candidatura agora!</button>
							</form>
						</div>
					</div>
				</div>
			</div>
			<!-- Modal Candidatura -->
			<div class="modal fade" id="modalCandidaturaEnviada_<?php echo $Vagas['id'] ?>" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h1 class="modal-title fs-5" id="exampleModalLabel">Você se candidatou na vaga:</h1>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<b>Sua candidatura foi enviada para a vaga abaixo:</b><br>
							<b>Vaga: </b><?php echo $Vagas['nome'] ?><br>
							<b>Empresa: </b><?php echo $EmpresaVaga['nome'] ?><br>
							<b>Tipo da Vaga: </b><?php echo mb_strtoupper($Vagas['local_trabalho']) ?><br>
							<div style="background-color #d1d1d1">
								<?php echo $obsCandidatura ?>
							</div>
							<hr>
							<form method="post" action="includes/removerCandidaturaAluno.php">
								<input type="hidden" name="id" value="<?php echo $idCandidatura ?>">
								Para remover esta candidaduta <button type="submit" class="link-remove-candidatura">clique aqui</button>.
							</form>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
						</div>
					</div>
				</div>
			</div>

<?php
		}
	}
?>		
		</div>
		<!-- FIM DAS VAGAS DISPONÍVEIS -->
	</div>
</div>
